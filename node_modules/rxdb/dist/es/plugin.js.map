{"version":3,"file":"plugin.js","names":["RxSchema","basePrototype","RxDocumentPrototype","RxQueryBase","RxCollectionBase","RxDatabaseBase","overwritable","HOOKS","runPluginHooks","newRxError","newRxTypeError","PROTOTYPES","prototype","RxDocument","RxQuery","RxCollection","RxDatabase","ADDED_PLUGINS","Set","ADDED_PLUGIN_NAMES","addRxPlugin","plugin","plugins","has","name","add","rxdb","init","prototypes","Object","entries","forEach","fun","assign","hooks","hooksObj","after","push","before","unshift"],"sources":["../../src/plugin.ts"],"sourcesContent":["/**\n * this handles how plugins are added to rxdb\n * basically it changes the internal prototypes\n * by passing them to the plugins-functions\n */\nimport {\n    RxSchema\n} from './rx-schema';\nimport {\n    basePrototype as RxDocumentPrototype\n} from './rx-document';\nimport {\n    RxQueryBase\n} from './rx-query';\nimport {\n    RxCollectionBase\n} from './rx-collection';\nimport {\n    RxDatabaseBase\n} from './rx-database';\nimport type {\n    RxPlugin\n} from './types';\n\nimport { overwritable } from './overwritable';\nimport {\n    HOOKS,\n    runPluginHooks\n} from './hooks';\nimport { newRxError, newRxTypeError } from './rx-error';\n\n/**\n * prototypes that can be manipulated with a plugin\n */\nconst PROTOTYPES: { [k: string]: any; } = {\n    RxSchema: RxSchema.prototype,\n    RxDocument: RxDocumentPrototype,\n    RxQuery: RxQueryBase.prototype,\n    RxCollection: RxCollectionBase.prototype,\n    RxDatabase: RxDatabaseBase.prototype\n};\n\nconst ADDED_PLUGINS: Set<RxPlugin | any> = new Set();\nconst ADDED_PLUGIN_NAMES: Set<string> = new Set();\n\n/**\n * Add a plugin to the RxDB library.\n * Plugins are added globally and cannot be removed.\n */\nexport function addRxPlugin(plugin: RxPlugin) {\n    runPluginHooks('preAddRxPlugin', { plugin, plugins: ADDED_PLUGINS });\n\n    // do nothing if added before\n    if (ADDED_PLUGINS.has(plugin)) {\n        return;\n    } else {\n\n        // ensure no other plugin with the same name was already added\n        if (ADDED_PLUGIN_NAMES.has(plugin.name)) {\n            throw newRxError('PL3', {\n                name: plugin.name,\n                plugin,\n            });\n        }\n\n        ADDED_PLUGINS.add(plugin);\n        ADDED_PLUGIN_NAMES.add(plugin.name);\n    }\n\n    /**\n     * To identify broken configurations,\n     * we only allow RxDB plugins to be passed into addRxPlugin().\n     */\n    if (!plugin.rxdb) {\n        throw newRxTypeError('PL1', {\n            plugin\n        });\n    }\n\n    if (plugin.init) {\n        plugin.init();\n    }\n\n    // prototype-overwrites\n    if (plugin.prototypes) {\n        Object\n            .entries(plugin.prototypes)\n            .forEach(([name, fun]) => {\n                return (fun as any)(PROTOTYPES[name]);\n            });\n    }\n    // overwritable-overwrites\n    if (plugin.overwritable) {\n        Object.assign(\n            overwritable,\n            plugin.overwritable\n        );\n    }\n    // extend-hooks\n    if (plugin.hooks) {\n        Object\n            .entries(plugin.hooks)\n            .forEach(([name, hooksObj]) => {\n                if (hooksObj.after) {\n                    HOOKS[name].push(hooksObj.after);\n                }\n                if (hooksObj.before) {\n                    HOOKS[name].unshift(hooksObj.before);\n                }\n            });\n    }\n}\n\n"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA,SACIA,QAAQ,QACL,aAAa;AACpB,SACIC,aAAa,IAAIC,mBAAmB,QACjC,eAAe;AACtB,SACIC,WAAW,QACR,YAAY;AACnB,SACIC,gBAAgB,QACb,iBAAiB;AACxB,SACIC,cAAc,QACX,eAAe;AAKtB,SAASC,YAAY,QAAQ,gBAAgB;AAC7C,SACIC,KAAK,EACLC,cAAc,QACX,SAAS;AAChB,SAASC,UAAU,EAAEC,cAAc,QAAQ,YAAY;;AAEvD;AACA;AACA;AACA,IAAMC,UAAiC,GAAG;EACtCX,QAAQ,EAAEA,QAAQ,CAACY,SAAS;EAC5BC,UAAU,EAAEX,mBAAmB;EAC/BY,OAAO,EAAEX,WAAW,CAACS,SAAS;EAC9BG,YAAY,EAAEX,gBAAgB,CAACQ,SAAS;EACxCI,UAAU,EAAEX,cAAc,CAACO;AAC/B,CAAC;AAED,IAAMK,aAAkC,GAAG,IAAIC,GAAG,EAAE;AACpD,IAAMC,kBAA+B,GAAG,IAAID,GAAG,EAAE;;AAEjD;AACA;AACA;AACA;AACA,OAAO,SAASE,WAAWA,CAACC,MAAgB,EAAE;EAC1Cb,cAAc,CAAC,gBAAgB,EAAE;IAAEa,MAAM;IAAEC,OAAO,EAAEL;EAAc,CAAC,CAAC;;EAEpE;EACA,IAAIA,aAAa,CAACM,GAAG,CAACF,MAAM,CAAC,EAAE;IAC3B;EACJ,CAAC,MAAM;IAEH;IACA,IAAIF,kBAAkB,CAACI,GAAG,CAACF,MAAM,CAACG,IAAI,CAAC,EAAE;MACrC,MAAMf,UAAU,CAAC,KAAK,EAAE;QACpBe,IAAI,EAAEH,MAAM,CAACG,IAAI;QACjBH;MACJ,CAAC,CAAC;IACN;IAEAJ,aAAa,CAACQ,GAAG,CAACJ,MAAM,CAAC;IACzBF,kBAAkB,CAACM,GAAG,CAACJ,MAAM,CAACG,IAAI,CAAC;EACvC;;EAEA;AACJ;AACA;AACA;EACI,IAAI,CAACH,MAAM,CAACK,IAAI,EAAE;IACd,MAAMhB,cAAc,CAAC,KAAK,EAAE;MACxBW;IACJ,CAAC,CAAC;EACN;EAEA,IAAIA,MAAM,CAACM,IAAI,EAAE;IACbN,MAAM,CAACM,IAAI,EAAE;EACjB;;EAEA;EACA,IAAIN,MAAM,CAACO,UAAU,EAAE;IACnBC,MAAM,CACDC,OAAO,CAACT,MAAM,CAACO,UAAU,CAAC,CAC1BG,OAAO,CAAC,CAAC,CAACP,IAAI,EAAEQ,GAAG,CAAC,KAAK;MACtB,OAAQA,GAAG,CAASrB,UAAU,CAACa,IAAI,CAAC,CAAC;IACzC,CAAC,CAAC;EACV;EACA;EACA,IAAIH,MAAM,CAACf,YAAY,EAAE;IACrBuB,MAAM,CAACI,MAAM,CACT3B,YAAY,EACZe,MAAM,CAACf,YAAY,CACtB;EACL;EACA;EACA,IAAIe,MAAM,CAACa,KAAK,EAAE;IACdL,MAAM,CACDC,OAAO,CAACT,MAAM,CAACa,KAAK,CAAC,CACrBH,OAAO,CAAC,CAAC,CAACP,IAAI,EAAEW,QAAQ,CAAC,KAAK;MAC3B,IAAIA,QAAQ,CAACC,KAAK,EAAE;QAChB7B,KAAK,CAACiB,IAAI,CAAC,CAACa,IAAI,CAACF,QAAQ,CAACC,KAAK,CAAC;MACpC;MACA,IAAID,QAAQ,CAACG,MAAM,EAAE;QACjB/B,KAAK,CAACiB,IAAI,CAAC,CAACe,OAAO,CAACJ,QAAQ,CAACG,MAAM,CAAC;MACxC;IACJ,CAAC,CAAC;EACV;AACJ"}