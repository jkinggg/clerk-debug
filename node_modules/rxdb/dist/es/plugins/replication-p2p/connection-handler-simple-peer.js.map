{"version":3,"file":"connection-handler-simple-peer.js","names":["Subject","getFromMapOrThrow","PROMISE_RESOLVE_VOID","randomCouchString","default","Peer","newRxError","getConnectionHandlerSimplePeer","serverUrl","wrtc","io","require","creator","options","socket","peerId","emit","room","topic","connect$","disconnect$","message$","response$","error$","peers","Map","on","roomPeerIds","forEach","remotePeerId","has","newPeer","initiator","trickle","set","messageOrResponse","JSON","parse","toString","result","next","peer","response","message","signal","from","to","error","data","handler","send","stringify","destroy","close","complete"],"sources":["../../../../src/plugins/replication-p2p/connection-handler-simple-peer.ts"],"sourcesContent":["import { Subject } from 'rxjs';\nimport { getFromMapOrThrow, PROMISE_RESOLVE_VOID, randomCouchString } from '../../plugins/utils';\nimport type {\n    P2PConnectionHandler,\n    P2PConnectionHandlerCreator,\n    P2PMessage,\n    P2PPeer,\n    PeerWithMessage,\n    PeerWithResponse\n} from './p2p-types';\n\nimport {\n    Instance as SimplePeer,\n    default as Peer\n} from 'simple-peer';\nimport { RxError, RxTypeError } from '../../types';\nimport { newRxError } from '../../rx-error';\n\n/**\n * Returns a connection handler that uses simple-peer and the signaling server.\n */\nexport function getConnectionHandlerSimplePeer(\n    serverUrl: string,\n    wrtc?: any\n): P2PConnectionHandlerCreator {\n    const { io } = require('socket.io-client');\n\n\n    const creator: P2PConnectionHandlerCreator = (options) => {\n        const socket = io(serverUrl);\n\n        const peerId = randomCouchString(10);\n        socket.emit('join', {\n            room: options.topic,\n            peerId\n        });\n\n        const connect$ = new Subject<P2PPeer>();\n        const disconnect$ = new Subject<P2PPeer>();\n        const message$ = new Subject<PeerWithMessage>();\n        const response$ = new Subject<PeerWithResponse>();\n        const error$ = new Subject<RxError | RxTypeError>();\n\n        const peers = new Map<string, SimplePeer>();\n\n        socket.on('joined', (roomPeerIds: string[]) => {\n            roomPeerIds.forEach(remotePeerId => {\n                if (\n                    remotePeerId === peerId ||\n                    peers.has(remotePeerId)\n                ) {\n                    return;\n                }\n                // console.log('other user joined room ' + remotePeerId);\n                const newPeer: SimplePeer = new Peer({\n                    initiator: remotePeerId > peerId,\n                    wrtc,\n                    trickle: true\n                }) as any;\n                peers.set(remotePeerId, newPeer);\n\n\n                newPeer.on('data', (messageOrResponse: any) => {\n                    messageOrResponse = JSON.parse(messageOrResponse.toString());\n                    // console.log('got a message from peer3: ' + messageOrResponse)\n                    if (messageOrResponse.result) {\n                        response$.next({\n                            peer: newPeer as any,\n                            response: messageOrResponse\n                        });\n                    } else {\n                        message$.next({\n                            peer: newPeer as any,\n                            message: messageOrResponse\n                        });\n                    }\n                });\n\n                newPeer.on('signal', (signal: any) => {\n                    // console.log('emit signal from ' + peerId + ' to ' + remotePeerId);\n                    socket.emit('signal', {\n                        from: peerId,\n                        to: remotePeerId,\n                        room: options.topic,\n                        signal\n                    });\n                });\n\n                newPeer.on('error', (error) => {\n                    error$.next(newRxError('RC_P2P_PEER', {\n                        error\n                    }));\n                });\n\n                newPeer.on('connect', () => {\n                    connect$.next(newPeer as any);\n                });\n\n            });\n        });\n\n        socket.on('signal', (data: any) => {\n            // console.log('got signal(' + peerId + ') ' + data.from + ' -> ' + data.to);\n            const peer = getFromMapOrThrow(peers, data.from);\n            peer.signal(data.signal);\n        });\n\n        const handler: P2PConnectionHandler = {\n            error$,\n            connect$,\n            disconnect$,\n            message$,\n            response$,\n            async send(peer: P2PPeer, message: P2PMessage) {\n                await (peer as any).send(JSON.stringify(message));\n            },\n            destroy() {\n                socket.close();\n                error$.complete();\n                connect$.complete();\n                disconnect$.complete();\n                message$.complete();\n                response$.complete();\n                return PROMISE_RESOLVE_VOID;\n            }\n        };\n        return handler;\n    };\n    return creator;\n}\n"],"mappings":"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"}