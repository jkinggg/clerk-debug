{"version":3,"file":"nosql-query-builder.js","names":["isObject","merge","newRxTypeError","newRxError","NoSqlQueryBuilderClass","mangoQuery","options","_conditions","_fields","queryBuilder","selector","find","limit","skip","sort","forEach","s","_proto","prototype","where","_path","_val","arguments","length","type","Array","isArray","path","equals","val","_ensurePath","eq","or","array","$or","push","apply","nor","$nor","and","$and","mod","slice","conds","$mod","exists","$exists","elemMatch","_criteria","fn","criteria","$elemMatch","arg","len","i","_pushArr","split","field","ascend","substring","keys","Object","args","source","canMerge","_distinct","method","toJSON","query","mQuerySortToRxDBSort","entries","map","k","v","direction","part","OTHER_MANGO_ATTRIBUTES","OTHER_MANGO_OPERATORS","$conditional","opts","value","$meta","String","toLowerCase","test","valueStr","toString","replace","parseInt","createQueryBuilder"],"sources":["../../../../../src/plugins/query-builder/mquery/nosql-query-builder.ts"],"sourcesContent":["/**\n * this is based on\n * @link https://github.com/aheckmann/mquery/blob/master/lib/mquery.js\n */\nimport {\n    isObject,\n    merge\n} from './mquery-utils';\nimport {\n    newRxTypeError,\n    newRxError\n} from '../../../rx-error';\nimport type {\n    MangoQuery,\n    MangoQuerySelector,\n    MangoQuerySortPart,\n    MangoQuerySortDirection\n} from '../../../types';\n\n\ndeclare type MQueryOptions = {\n    limit?: number;\n    skip?: number;\n    sort?: any;\n};\n\nexport class NoSqlQueryBuilderClass<DocType> {\n\n    public options: MQueryOptions = {};\n    public _conditions: MangoQuerySelector<DocType> = {};\n    public _fields: any = {};\n    public _path?: any;\n    private _distinct: any;\n\n    /**\n     * MQuery constructor used for building queries.\n     *\n     * ####Example:\n     *     var query = new MQuery({ name: 'mquery' });\n     *     query.where('age').gte(21).exec(callback);\n     *\n     */\n    constructor(\n        mangoQuery?: MangoQuery<DocType>\n    ) {\n        if (mangoQuery) {\n            const queryBuilder: NoSqlQueryBuilder<DocType> = this as any;\n\n            if (mangoQuery.selector) {\n                queryBuilder.find(mangoQuery.selector);\n            }\n            if (mangoQuery.limit) {\n                queryBuilder.limit(mangoQuery.limit);\n            }\n            if (mangoQuery.skip) {\n                queryBuilder.skip(mangoQuery.skip);\n            }\n            if (mangoQuery.sort) {\n                mangoQuery.sort.forEach(s => queryBuilder.sort(s));\n            }\n        }\n    }\n\n    /**\n     * Specifies a `path` for use with chaining.\n     */\n    where(_path: string, _val?: MangoQuerySelector<DocType>): NoSqlQueryBuilder<DocType> {\n        if (!arguments.length) return this as any;\n        const type = typeof arguments[0];\n        if ('string' === type) {\n            this._path = arguments[0];\n            if (2 === arguments.length) {\n                (this._conditions as any)[this._path] = arguments[1];\n            }\n            return this as any;\n        }\n\n        if ('object' === type && !Array.isArray(arguments[0])) {\n            return this.merge(arguments[0]);\n        }\n\n        throw newRxTypeError('MQ1', {\n            path: arguments[0]\n        });\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * ####Example\n     *     User.where('age').equals(49);\n     */\n    equals(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('equals');\n        const path = this._path;\n        (this._conditions as any)[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * This is alias of `equals`\n     */\n    eq(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('eq');\n        const path = this._path;\n        (this._conditions as any)[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for an `$or` condition.\n     * ####Example\n     *     query.or([{ color: 'red' }, { status: 'emergency' }])\n     */\n    or(array: any[]): NoSqlQueryBuilder<DocType> {\n        const or = this._conditions.$or || (this._conditions.$or = []);\n        if (!Array.isArray(array)) array = [array];\n        or.push.apply(or, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$nor` condition.\n     * ####Example\n     *     query.nor([{ color: 'green' }, { status: 'ok' }])\n     */\n    nor(array: any[]): NoSqlQueryBuilder<DocType> {\n        const nor = this._conditions.$nor || (this._conditions.$nor = []);\n        if (!Array.isArray(array)) array = [array];\n        nor.push.apply(nor, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$and` condition.\n     * ####Example\n     *     query.and([{ color: 'green' }, { status: 'ok' }])\n     * @see $and http://docs.mongodb.org/manual/reference/operator/and/\n     */\n    and(array: any[]): NoSqlQueryBuilder<DocType> {\n        const and = this._conditions.$and || (this._conditions.$and = []);\n        if (!Array.isArray(array)) array = [array];\n        and.push.apply(and, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies a `$mod` condition\n     */\n    mod(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let val;\n        let path;\n\n        if (1 === arguments.length) {\n            this._ensurePath('mod');\n            val = arguments[0];\n            path = this._path;\n        } else if (2 === arguments.length && !Array.isArray(arguments[1])) {\n            this._ensurePath('mod');\n            val = (arguments as any).slice();\n            path = this._path;\n        } else if (3 === arguments.length) {\n            val = (arguments as any).slice(1);\n            path = arguments[0];\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = (this._conditions as any)[path] || ((this._conditions as any)[path] = {});\n        conds.$mod = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$exists` condition\n     * ####Example\n     *     // { name: { $exists: true }}\n     *     Thing.where('name').exists()\n     *     Thing.where('name').exists(true)\n     *     Thing.find().exists('name')\n     */\n    exists(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let path;\n        let val;\n        if (0 === arguments.length) {\n            this._ensurePath('exists');\n            path = this._path;\n            val = true;\n        } else if (1 === arguments.length) {\n            if ('boolean' === typeof arguments[0]) {\n                this._ensurePath('exists');\n                path = this._path;\n                val = arguments[0];\n            } else {\n                path = arguments[0];\n                val = true;\n            }\n        } else if (2 === arguments.length) {\n            path = arguments[0];\n            val = arguments[1];\n        }\n\n        const conds = (this._conditions as any)[path] || ((this._conditions as any)[path] = {});\n        conds.$exists = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$elemMatch` condition\n     * ####Example\n     *     query.elemMatch('comment', { author: 'autobot', votes: {$gte: 5}})\n     *     query.where('comment').elemMatch({ author: 'autobot', votes: {$gte: 5}})\n     *     query.elemMatch('comment', function (elem) {\n     *       elem.where('author').equals('autobot');\n     *       elem.where('votes').gte(5);\n     *     })\n     *     query.where('comment').elemMatch(function (elem) {\n     *       elem.where({ author: 'autobot' });\n     *       elem.where('votes').gte(5);\n     *     })\n     */\n    elemMatch(_path: string, _criteria: any): NoSqlQueryBuilder<DocType> {\n        if (null === arguments[0])\n            throw newRxTypeError('MQ2');\n\n        let fn;\n        let path;\n        let criteria;\n\n        if ('function' === typeof arguments[0]) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            fn = arguments[0];\n        } else if (isObject(arguments[0])) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            criteria = arguments[0];\n        } else if ('function' === typeof arguments[1]) {\n            path = arguments[0];\n            fn = arguments[1];\n        } else if (arguments[1] && isObject(arguments[1])) {\n            path = arguments[0];\n            criteria = arguments[1];\n        } else\n            throw newRxTypeError('MQ2');\n\n        if (fn) {\n            criteria = new NoSqlQueryBuilderClass;\n            fn(criteria);\n            criteria = criteria._conditions;\n        }\n\n        const conds = (this._conditions as any)[path] || ((this._conditions as any)[path] = {});\n        conds.$elemMatch = criteria;\n        return this as any;\n    }\n\n    /**\n     * Sets the sort order\n     * If an object is passed, values allowed are 'asc', 'desc', 'ascending', 'descending', 1, and -1.\n     * If a string is passed, it must be a space delimited list of path names.\n     * The sort order of each path is ascending unless the path name is prefixed with `-` which will be treated as descending.\n     * ####Example\n     *     query.sort({ field: 'asc', test: -1 });\n     *     query.sort('field -test');\n     *     query.sort([['field', 1], ['test', -1]]);\n     */\n    sort(arg: any): NoSqlQueryBuilder<DocType> {\n        if (!arg) return this as any;\n        let len;\n        const type = typeof arg;\n        // .sort([['field', 1], ['test', -1]])\n        if (Array.isArray(arg)) {\n            len = arg.length;\n            for (let i = 0; i < arg.length; ++i) {\n                _pushArr(this.options, arg[i][0], arg[i][1]);\n            }\n\n            return this as any;\n        }\n\n        // .sort('field -test')\n        if (1 === arguments.length && 'string' === type) {\n            arg = arg.split(/\\s+/);\n            len = arg.length;\n            for (let i = 0; i < len; ++i) {\n                let field = arg[i];\n                if (!field) continue;\n                const ascend = '-' === field[0] ? -1 : 1;\n                if (ascend === -1) field = field.substring(1);\n                push(this.options, field, ascend);\n            }\n\n            return this as any;\n        }\n\n        // .sort({ field: 1, test: -1 })\n        if (isObject(arg)) {\n            const keys = Object.keys(arg);\n            keys.forEach(field => push(this.options, field, arg[field]));\n            return this as any;\n        }\n\n        throw newRxTypeError('MQ3', {\n            args: arguments\n        });\n    }\n\n    /**\n     * Merges another MQuery or conditions object into this one.\n     *\n     * When a MQuery is passed, conditions, field selection and options are merged.\n     *\n     */\n    merge(source: any): NoSqlQueryBuilder<DocType> {\n        if (!source) {\n            return this as any;\n        }\n\n        if (!canMerge(source)) {\n            throw newRxTypeError('MQ4', {\n                source\n            });\n        }\n\n        if (source instanceof NoSqlQueryBuilderClass) {\n            // if source has a feature, apply it to ourselves\n\n            if (source._conditions)\n                merge(this._conditions, source._conditions);\n\n            if (source._fields) {\n                if (!this._fields) this._fields = {};\n                merge(this._fields, source._fields);\n            }\n\n            if (source.options) {\n                if (!this.options) this.options = {};\n                merge(this.options, source.options);\n            }\n\n            if (source._distinct)\n                this._distinct = source._distinct;\n\n            return this as any;\n        }\n\n        // plain object\n        merge(this._conditions, source);\n\n        return this as any;\n    }\n\n    /**\n     * Finds documents.\n     * ####Example\n     *     query.find()\n     *     query.find({ name: 'Burning Lights' })\n     */\n    find(criteria: any): NoSqlQueryBuilder<DocType> {\n        if (canMerge(criteria)) {\n            this.merge(criteria);\n        }\n\n        return this as any;\n    }\n\n    /**\n     * Make sure _path is set.\n     *\n     * @param {String} method\n     */\n    _ensurePath(method: any) {\n        if (!this._path) {\n            throw newRxError('MQ5', {\n                method\n            });\n        }\n    }\n\n    toJSON(): {\n        query: MangoQuery<DocType>;\n        path?: string;\n    } {\n        const query: MangoQuery<DocType> = {\n            selector: this._conditions,\n        };\n\n        if (this.options.skip) {\n            query.skip = this.options.skip;\n        }\n        if (this.options.limit) {\n            query.limit = this.options.limit;\n        }\n        if (this.options.sort) {\n            query.sort = mQuerySortToRxDBSort(this.options.sort);\n        }\n\n        return {\n            query,\n            path: this._path\n        };\n    }\n}\n\nexport function mQuerySortToRxDBSort<DocType>(\n    sort: { [k: string]: 1 | -1; }\n): MangoQuerySortPart<DocType>[] {\n    return Object.entries(sort).map(([k, v]) => {\n        const direction: MangoQuerySortDirection = v === 1 ? 'asc' : 'desc';\n        const part: MangoQuerySortPart<DocType> = { [k]: direction } as any;\n        return part;\n    });\n}\n\n/**\n * Because some prototype-methods are generated,\n * we have to define the type of NoSqlQueryBuilder here\n */\n\nexport interface NoSqlQueryBuilder<DocType = any> extends NoSqlQueryBuilderClass<DocType> {\n    maxScan: ReturnSelfNumberFunction<DocType>;\n    batchSize: ReturnSelfNumberFunction<DocType>;\n    limit: ReturnSelfNumberFunction<DocType>;\n    skip: ReturnSelfNumberFunction<DocType>;\n    comment: ReturnSelfFunction<DocType>;\n\n    gt: ReturnSelfFunction<DocType>;\n    gte: ReturnSelfFunction<DocType>;\n    lt: ReturnSelfFunction<DocType>;\n    lte: ReturnSelfFunction<DocType>;\n    ne: ReturnSelfFunction<DocType>;\n    in: ReturnSelfFunction<DocType>;\n    nin: ReturnSelfFunction<DocType>;\n    all: ReturnSelfFunction<DocType>;\n    regex: ReturnSelfFunction<DocType>;\n    size: ReturnSelfFunction<DocType>;\n\n}\n\ndeclare type ReturnSelfFunction<DocType> = (v: any) => NoSqlQueryBuilder<DocType>;\ndeclare type ReturnSelfNumberFunction<DocType> = (v: number | null) => NoSqlQueryBuilder<DocType>;\n\n/**\n * limit, skip, maxScan, batchSize, comment\n *\n * Sets these associated options.\n *\n *     query.comment('feed query');\n */\nexport const OTHER_MANGO_ATTRIBUTES = ['limit', 'skip', 'maxScan', 'batchSize', 'comment'];\nOTHER_MANGO_ATTRIBUTES.forEach(function (method) {\n    (NoSqlQueryBuilderClass.prototype as any)[method] = function (v: any) {\n        this.options[method] = v;\n        return this;\n    };\n});\n\n\n/**\n * gt, gte, lt, lte, ne, in, nin, all, regex, size, maxDistance\n *\n *     Thing.where('type').nin(array)\n */\nexport const OTHER_MANGO_OPERATORS = [\n    'gt', 'gte', 'lt', 'lte', 'ne',\n    'in', 'nin', 'all', 'regex', 'size'\n];\nOTHER_MANGO_OPERATORS.forEach(function ($conditional) {\n    (NoSqlQueryBuilderClass.prototype as any)[$conditional] = function () {\n        let path;\n        let val;\n        if (1 === arguments.length) {\n            this._ensurePath($conditional);\n            val = arguments[0];\n            path = this._path;\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = this._conditions[path] === null || typeof this._conditions[path] === 'object' ?\n            this._conditions[path] :\n            (this._conditions[path] = {});\n        conds['$' + $conditional] = val;\n        return this;\n    };\n});\n\n\nfunction push(opts: any, field: string, value: any) {\n    if (Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ6', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    if (value && value.$meta) {\n        const sort = opts.sort || (opts.sort = {});\n        sort[field] = {\n            $meta: value.$meta\n        };\n        return;\n    }\n\n    const val = String(value || 1).toLowerCase();\n    if (!/^(?:ascending|asc|descending|desc|1|-1)$/.test(val)) {\n        if (Array.isArray(value)) value = '[' + value + ']';\n        throw newRxTypeError('MQ7', {\n            field,\n            value\n        });\n    }\n    // store `sort` in a sane format\n    const s = opts.sort || (opts.sort = {});\n    const valueStr = value.toString()\n        .replace('asc', '1')\n        .replace('ascending', '1')\n        .replace('desc', '-1')\n        .replace('descending', '-1');\n    s[field] = parseInt(valueStr, 10);\n}\n\nfunction _pushArr(opts: any, field: string, value: any) {\n    opts.sort = opts.sort || [];\n    if (!Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ8', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    /*    const valueStr = value.toString()\n            .replace('asc', '1')\n            .replace('ascending', '1')\n            .replace('desc', '-1')\n            .replace('descending', '-1');*/\n    opts.sort.push([field, value]);\n}\n\n\n/**\n * Determines if `conds` can be merged using `mquery().merge()`\n */\nexport function canMerge(conds: any): boolean {\n    return conds instanceof NoSqlQueryBuilderClass || isObject(conds);\n}\n\n\nexport function createQueryBuilder<DocType>(query?: MangoQuery<DocType>): NoSqlQueryBuilder<DocType> {\n    return new NoSqlQueryBuilderClass(query) as NoSqlQueryBuilder<DocType>;\n}\n"],"mappings":"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"}