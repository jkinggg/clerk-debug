{"version":3,"file":"index.js","names":["combineLatest","shareReplay","switchMap","PROMISE_RESOLVE_FALSE","RXJS_SHARE_REPLAY_DEFAULTS","mustMigrate","DataMigrator","getMigrationStateByDatabase","onDatabaseDestroy","DATA_MIGRATOR_BY_COLLECTION","WeakMap","RxDBMigrationPlugin","name","rxdb","hooks","preDestroyRxDatabase","after","prototypes","RxDatabase","proto","migrationStates","pipe","list","RxCollection","getDataMigrator","has","set","asRxCollection","migrationStrategies","get","migrationNeeded","schema","version","_getOldCollections","getBatchOfOldCollection","migrateDocumentData","_migrateDocuments","deleteOldCollection","migrateOldCollection","migratePromise"],"sources":["../../../../src/plugins/migration/index.ts"],"sourcesContent":["import {\n    combineLatest,\n    Observable\n} from 'rxjs';\nimport {\n    shareReplay,\n    switchMap\n} from 'rxjs/operators';\nimport type {\n    RxPlugin,\n    RxCollection,\n    RxDatabase,\n    AllMigrationStates\n} from '../../types';\nimport { PROMISE_RESOLVE_FALSE, RXJS_SHARE_REPLAY_DEFAULTS } from '../../plugins/utils';\nimport {\n    mustMigrate,\n    DataMigrator\n} from './data-migrator';\nimport {\n    getMigrationStateByDatabase,\n    onDatabaseDestroy\n} from './migration-state';\n\nexport const DATA_MIGRATOR_BY_COLLECTION: WeakMap<RxCollection, DataMigrator> = new WeakMap();\n\nexport const RxDBMigrationPlugin: RxPlugin = {\n    name: 'migration',\n    rxdb: true,\n    hooks: {\n        preDestroyRxDatabase: {\n            after: onDatabaseDestroy\n        }\n    },\n    prototypes: {\n        RxDatabase: (proto: any) => {\n            proto.migrationStates = function (this: RxDatabase): Observable<AllMigrationStates> {\n                return getMigrationStateByDatabase(this).pipe(\n                    switchMap(list => combineLatest(list)),\n                    shareReplay(RXJS_SHARE_REPLAY_DEFAULTS)\n                );\n            };\n        },\n        RxCollection: (proto: any) => {\n            proto.getDataMigrator = function (this: RxCollection): DataMigrator {\n                if (!DATA_MIGRATOR_BY_COLLECTION.has(this)) {\n                    DATA_MIGRATOR_BY_COLLECTION.set(\n                        this,\n                        new DataMigrator(\n                            this.asRxCollection,\n                            this.migrationStrategies\n                        )\n                    );\n\n                }\n                return DATA_MIGRATOR_BY_COLLECTION.get(this) as any;\n            };\n            proto.migrationNeeded = function (this: RxCollection) {\n                if (this.schema.version === 0) {\n                    return PROMISE_RESOLVE_FALSE;\n                }\n                return mustMigrate(this.getDataMigrator());\n            };\n        }\n    }\n};\n\n\n// used in tests\nexport {\n    _getOldCollections,\n    getBatchOfOldCollection,\n    migrateDocumentData,\n    _migrateDocuments,\n    deleteOldCollection,\n    migrateOldCollection,\n    migratePromise,\n    DataMigrator\n} from './data-migrator';\n"],"mappings":"AAAA,SACIA,aAAa,QAEV,MAAM;AACb,SACIC,WAAW,EACXC,SAAS,QACN,gBAAgB;AAOvB,SAASC,qBAAqB,EAAEC,0BAA0B,QAAQ,qBAAqB;AACvF,SACIC,WAAW,EACXC,YAAY,QACT,iBAAiB;AACxB,SACIC,2BAA2B,EAC3BC,iBAAiB,QACd,mBAAmB;AAE1B,OAAO,IAAMC,2BAAgE,GAAG,IAAIC,OAAO,EAAE;AAE7F,OAAO,IAAMC,mBAA6B,GAAG;EACzCC,IAAI,EAAE,WAAW;EACjBC,IAAI,EAAE,IAAI;EACVC,KAAK,EAAE;IACHC,oBAAoB,EAAE;MAClBC,KAAK,EAAER;IACX;EACJ,CAAC;EACDS,UAAU,EAAE;IACRC,UAAU,EAAGC,KAAU,IAAK;MACxBA,KAAK,CAACC,eAAe,GAAG,YAA4D;QAChF,OAAOb,2BAA2B,CAAC,IAAI,CAAC,CAACc,IAAI,CACzCnB,SAAS,CAACoB,IAAI,IAAItB,aAAa,CAACsB,IAAI,CAAC,CAAC,EACtCrB,WAAW,CAACG,0BAA0B,CAAC,CAC1C;MACL,CAAC;IACL,CAAC;IACDmB,YAAY,EAAGJ,KAAU,IAAK;MAC1BA,KAAK,CAACK,eAAe,GAAG,YAA4C;QAChE,IAAI,CAACf,2BAA2B,CAACgB,GAAG,CAAC,IAAI,CAAC,EAAE;UACxChB,2BAA2B,CAACiB,GAAG,CAC3B,IAAI,EACJ,IAAIpB,YAAY,CACZ,IAAI,CAACqB,cAAc,EACnB,IAAI,CAACC,mBAAmB,CAC3B,CACJ;QAEL;QACA,OAAOnB,2BAA2B,CAACoB,GAAG,CAAC,IAAI,CAAC;MAChD,CAAC;MACDV,KAAK,CAACW,eAAe,GAAG,YAA8B;QAClD,IAAI,IAAI,CAACC,MAAM,CAACC,OAAO,KAAK,CAAC,EAAE;UAC3B,OAAO7B,qBAAqB;QAChC;QACA,OAAOE,WAAW,CAAC,IAAI,CAACmB,eAAe,EAAE,CAAC;MAC9C,CAAC;IACL;EACJ;AACJ,CAAC;;AAGD;AACA,SACIS,kBAAkB,EAClBC,uBAAuB,EACvBC,mBAAmB,EACnBC,iBAAiB,EACjBC,mBAAmB,EACnBC,oBAAoB,EACpBC,cAAc,EACdjC,YAAY,QACT,iBAAiB"}