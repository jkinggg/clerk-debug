{"version":3,"file":"graphql-websocket.js","names":["_graphqlWs","require","_utils","_isomorphicWs","_interopRequireDefault","WebSocket","IsomorphicWebSocket","ws","GRAPHQL_WEBSOCKET_BY_URL","Map","exports","getGraphQLWebSocket","url","has","get","wsClient","createClient","shouldRetry","webSocketImpl","socket","refCount","set","removeGraphQLWebSocketRef","obj","getFromMapOrThrow","delete","dispose"],"sources":["../../../../src/plugins/replication-graphql/graphql-websocket.ts"],"sourcesContent":["import { Client, createClient } from 'graphql-ws';\nimport { getFromMapOrThrow } from '../../plugins/utils';\nimport ws from 'isomorphic-ws';\n\nconst { WebSocket: IsomorphicWebSocket } = ws;\n\nexport type WebsocketWithRefCount = {\n    url: string;\n    socket: Client;\n    refCount: number;\n};\n\nexport const GRAPHQL_WEBSOCKET_BY_URL: Map<string, WebsocketWithRefCount> = new Map();\n\n\nexport function getGraphQLWebSocket(\n    url: string\n): Client {\n    let has = GRAPHQL_WEBSOCKET_BY_URL.get(url);\n    if (!has) {\n        const wsClient = createClient({\n            url,\n            shouldRetry: () => true,\n            webSocketImpl: IsomorphicWebSocket,\n        });\n        has = {\n            url,\n            socket: wsClient,\n            refCount: 1\n        };\n        GRAPHQL_WEBSOCKET_BY_URL.set(url, has);\n    } else {\n        has.refCount = has.refCount + 1;\n    }\n    return has.socket;\n}\n\n\nexport function removeGraphQLWebSocketRef(\n    url: string\n) {\n    const obj = getFromMapOrThrow(GRAPHQL_WEBSOCKET_BY_URL, url);\n    obj.refCount = obj.refCount - 1;\n    if (obj.refCount === 0) {\n        GRAPHQL_WEBSOCKET_BY_URL.delete(url);\n        obj.socket.dispose();\n    }\n}\n"],"mappings":";;;;;;;;;AAAA,IAAAA,UAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AACA,IAAAE,aAAA,GAAAC,sBAAA,CAAAH,OAAA;AAEA,IAAM;EAAEI,SAAS,EAAEC;AAAoB,CAAC,GAAGC,qBAAE;AAQtC,IAAMC,wBAA4D,GAAG,IAAIC,GAAG,EAAE;AAACC,OAAA,CAAAF,wBAAA,GAAAA,wBAAA;AAG/E,SAASG,mBAAmBA,CAC/BC,GAAW,EACL;EACN,IAAIC,GAAG,GAAGL,wBAAwB,CAACM,GAAG,CAACF,GAAG,CAAC;EAC3C,IAAI,CAACC,GAAG,EAAE;IACN,IAAME,QAAQ,GAAG,IAAAC,uBAAY,EAAC;MAC1BJ,GAAG;MACHK,WAAW,EAAEA,CAAA,KAAM,IAAI;MACvBC,aAAa,EAAEZ;IACnB,CAAC,CAAC;IACFO,GAAG,GAAG;MACFD,GAAG;MACHO,MAAM,EAAEJ,QAAQ;MAChBK,QAAQ,EAAE;IACd,CAAC;IACDZ,wBAAwB,CAACa,GAAG,CAACT,GAAG,EAAEC,GAAG,CAAC;EAC1C,CAAC,MAAM;IACHA,GAAG,CAACO,QAAQ,GAAGP,GAAG,CAACO,QAAQ,GAAG,CAAC;EACnC;EACA,OAAOP,GAAG,CAACM,MAAM;AACrB;AAGO,SAASG,yBAAyBA,CACrCV,GAAW,EACb;EACE,IAAMW,GAAG,GAAG,IAAAC,wBAAiB,EAAChB,wBAAwB,EAAEI,GAAG,CAAC;EAC5DW,GAAG,CAACH,QAAQ,GAAGG,GAAG,CAACH,QAAQ,GAAG,CAAC;EAC/B,IAAIG,GAAG,CAACH,QAAQ,KAAK,CAAC,EAAE;IACpBZ,wBAAwB,CAACiB,MAAM,CAACb,GAAG,CAAC;IACpCW,GAAG,CAACJ,MAAM,CAACO,OAAO,EAAE;EACxB;AACJ"}