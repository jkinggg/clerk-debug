{"version":3,"file":"connection-handler-simple-peer.js","names":["_rxjs","require","_utils","_simplePeer","_interopRequireDefault","_rxError","getConnectionHandlerSimplePeer","serverUrl","wrtc","io","creator","options","socket","peerId","randomCouchString","emit","room","topic","connect$","Subject","disconnect$","message$","response$","error$","peers","Map","on","roomPeerIds","forEach","remotePeerId","has","newPeer","Peer","initiator","trickle","set","messageOrResponse","JSON","parse","toString","result","next","peer","response","message","signal","from","to","error","newRxError","data","getFromMapOrThrow","handler","send","stringify","destroy","close","complete","PROMISE_RESOLVE_VOID"],"sources":["../../../../src/plugins/replication-p2p/connection-handler-simple-peer.ts"],"sourcesContent":["import { Subject } from 'rxjs';\nimport { getFromMapOrThrow, PROMISE_RESOLVE_VOID, randomCouchString } from '../../plugins/utils';\nimport type {\n    P2PConnectionHandler,\n    P2PConnectionHandlerCreator,\n    P2PMessage,\n    P2PPeer,\n    PeerWithMessage,\n    PeerWithResponse\n} from './p2p-types';\n\nimport {\n    Instance as SimplePeer,\n    default as Peer\n} from 'simple-peer';\nimport { RxError, RxTypeError } from '../../types';\nimport { newRxError } from '../../rx-error';\n\n/**\n * Returns a connection handler that uses simple-peer and the signaling server.\n */\nexport function getConnectionHandlerSimplePeer(\n    serverUrl: string,\n    wrtc?: any\n): P2PConnectionHandlerCreator {\n    const { io } = require('socket.io-client');\n\n\n    const creator: P2PConnectionHandlerCreator = (options) => {\n        const socket = io(serverUrl);\n\n        const peerId = randomCouchString(10);\n        socket.emit('join', {\n            room: options.topic,\n            peerId\n        });\n\n        const connect$ = new Subject<P2PPeer>();\n        const disconnect$ = new Subject<P2PPeer>();\n        const message$ = new Subject<PeerWithMessage>();\n        const response$ = new Subject<PeerWithResponse>();\n        const error$ = new Subject<RxError | RxTypeError>();\n\n        const peers = new Map<string, SimplePeer>();\n\n        socket.on('joined', (roomPeerIds: string[]) => {\n            roomPeerIds.forEach(remotePeerId => {\n                if (\n                    remotePeerId === peerId ||\n                    peers.has(remotePeerId)\n                ) {\n                    return;\n                }\n                // console.log('other user joined room ' + remotePeerId);\n                const newPeer: SimplePeer = new Peer({\n                    initiator: remotePeerId > peerId,\n                    wrtc,\n                    trickle: true\n                }) as any;\n                peers.set(remotePeerId, newPeer);\n\n\n                newPeer.on('data', (messageOrResponse: any) => {\n                    messageOrResponse = JSON.parse(messageOrResponse.toString());\n                    // console.log('got a message from peer3: ' + messageOrResponse)\n                    if (messageOrResponse.result) {\n                        response$.next({\n                            peer: newPeer as any,\n                            response: messageOrResponse\n                        });\n                    } else {\n                        message$.next({\n                            peer: newPeer as any,\n                            message: messageOrResponse\n                        });\n                    }\n                });\n\n                newPeer.on('signal', (signal: any) => {\n                    // console.log('emit signal from ' + peerId + ' to ' + remotePeerId);\n                    socket.emit('signal', {\n                        from: peerId,\n                        to: remotePeerId,\n                        room: options.topic,\n                        signal\n                    });\n                });\n\n                newPeer.on('error', (error) => {\n                    error$.next(newRxError('RC_P2P_PEER', {\n                        error\n                    }));\n                });\n\n                newPeer.on('connect', () => {\n                    connect$.next(newPeer as any);\n                });\n\n            });\n        });\n\n        socket.on('signal', (data: any) => {\n            // console.log('got signal(' + peerId + ') ' + data.from + ' -> ' + data.to);\n            const peer = getFromMapOrThrow(peers, data.from);\n            peer.signal(data.signal);\n        });\n\n        const handler: P2PConnectionHandler = {\n            error$,\n            connect$,\n            disconnect$,\n            message$,\n            response$,\n            async send(peer: P2PPeer, message: P2PMessage) {\n                await (peer as any).send(JSON.stringify(message));\n            },\n            destroy() {\n                socket.close();\n                error$.complete();\n                connect$.complete();\n                disconnect$.complete();\n                message$.complete();\n                response$.complete();\n                return PROMISE_RESOLVE_VOID;\n            }\n        };\n        return handler;\n    };\n    return creator;\n}\n"],"mappings":"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"}