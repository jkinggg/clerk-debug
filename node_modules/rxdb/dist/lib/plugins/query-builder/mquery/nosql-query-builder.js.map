{"version":3,"file":"nosql-query-builder.js","names":["_mqueryUtils","require","_rxError","NoSqlQueryBuilderClass","mangoQuery","options","_conditions","_fields","queryBuilder","selector","find","limit","skip","sort","forEach","s","_proto","prototype","where","_path","_val","arguments","length","type","Array","isArray","merge","newRxTypeError","path","equals","val","_ensurePath","eq","or","array","$or","push","apply","nor","$nor","and","$and","mod","slice","conds","$mod","exists","$exists","elemMatch","_criteria","fn","criteria","isObject","$elemMatch","arg","len","i","_pushArr","split","field","ascend","substring","keys","Object","args","source","canMerge","_distinct","method","newRxError","toJSON","query","mQuerySortToRxDBSort","exports","entries","map","k","v","direction","part","OTHER_MANGO_ATTRIBUTES","OTHER_MANGO_OPERATORS","$conditional","opts","value","$meta","String","toLowerCase","test","valueStr","toString","replace","parseInt","createQueryBuilder"],"sources":["../../../../../src/plugins/query-builder/mquery/nosql-query-builder.ts"],"sourcesContent":["/**\n * this is based on\n * @link https://github.com/aheckmann/mquery/blob/master/lib/mquery.js\n */\nimport {\n    isObject,\n    merge\n} from './mquery-utils';\nimport {\n    newRxTypeError,\n    newRxError\n} from '../../../rx-error';\nimport type {\n    MangoQuery,\n    MangoQuerySelector,\n    MangoQuerySortPart,\n    MangoQuerySortDirection\n} from '../../../types';\n\n\ndeclare type MQueryOptions = {\n    limit?: number;\n    skip?: number;\n    sort?: any;\n};\n\nexport class NoSqlQueryBuilderClass<DocType> {\n\n    public options: MQueryOptions = {};\n    public _conditions: MangoQuerySelector<DocType> = {};\n    public _fields: any = {};\n    public _path?: any;\n    private _distinct: any;\n\n    /**\n     * MQuery constructor used for building queries.\n     *\n     * ####Example:\n     *     var query = new MQuery({ name: 'mquery' });\n     *     query.where('age').gte(21).exec(callback);\n     *\n     */\n    constructor(\n        mangoQuery?: MangoQuery<DocType>\n    ) {\n        if (mangoQuery) {\n            const queryBuilder: NoSqlQueryBuilder<DocType> = this as any;\n\n            if (mangoQuery.selector) {\n                queryBuilder.find(mangoQuery.selector);\n            }\n            if (mangoQuery.limit) {\n                queryBuilder.limit(mangoQuery.limit);\n            }\n            if (mangoQuery.skip) {\n                queryBuilder.skip(mangoQuery.skip);\n            }\n            if (mangoQuery.sort) {\n                mangoQuery.sort.forEach(s => queryBuilder.sort(s));\n            }\n        }\n    }\n\n    /**\n     * Specifies a `path` for use with chaining.\n     */\n    where(_path: string, _val?: MangoQuerySelector<DocType>): NoSqlQueryBuilder<DocType> {\n        if (!arguments.length) return this as any;\n        const type = typeof arguments[0];\n        if ('string' === type) {\n            this._path = arguments[0];\n            if (2 === arguments.length) {\n                (this._conditions as any)[this._path] = arguments[1];\n            }\n            return this as any;\n        }\n\n        if ('object' === type && !Array.isArray(arguments[0])) {\n            return this.merge(arguments[0]);\n        }\n\n        throw newRxTypeError('MQ1', {\n            path: arguments[0]\n        });\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * ####Example\n     *     User.where('age').equals(49);\n     */\n    equals(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('equals');\n        const path = this._path;\n        (this._conditions as any)[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies the complementary comparison value for paths specified with `where()`\n     * This is alias of `equals`\n     */\n    eq(val: any): NoSqlQueryBuilder<DocType> {\n        this._ensurePath('eq');\n        const path = this._path;\n        (this._conditions as any)[path] = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for an `$or` condition.\n     * ####Example\n     *     query.or([{ color: 'red' }, { status: 'emergency' }])\n     */\n    or(array: any[]): NoSqlQueryBuilder<DocType> {\n        const or = this._conditions.$or || (this._conditions.$or = []);\n        if (!Array.isArray(array)) array = [array];\n        or.push.apply(or, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$nor` condition.\n     * ####Example\n     *     query.nor([{ color: 'green' }, { status: 'ok' }])\n     */\n    nor(array: any[]): NoSqlQueryBuilder<DocType> {\n        const nor = this._conditions.$nor || (this._conditions.$nor = []);\n        if (!Array.isArray(array)) array = [array];\n        nor.push.apply(nor, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies arguments for a `$and` condition.\n     * ####Example\n     *     query.and([{ color: 'green' }, { status: 'ok' }])\n     * @see $and http://docs.mongodb.org/manual/reference/operator/and/\n     */\n    and(array: any[]): NoSqlQueryBuilder<DocType> {\n        const and = this._conditions.$and || (this._conditions.$and = []);\n        if (!Array.isArray(array)) array = [array];\n        and.push.apply(and, array);\n        return this as any;\n    }\n\n    /**\n     * Specifies a `$mod` condition\n     */\n    mod(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let val;\n        let path;\n\n        if (1 === arguments.length) {\n            this._ensurePath('mod');\n            val = arguments[0];\n            path = this._path;\n        } else if (2 === arguments.length && !Array.isArray(arguments[1])) {\n            this._ensurePath('mod');\n            val = (arguments as any).slice();\n            path = this._path;\n        } else if (3 === arguments.length) {\n            val = (arguments as any).slice(1);\n            path = arguments[0];\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = (this._conditions as any)[path] || ((this._conditions as any)[path] = {});\n        conds.$mod = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$exists` condition\n     * ####Example\n     *     // { name: { $exists: true }}\n     *     Thing.where('name').exists()\n     *     Thing.where('name').exists(true)\n     *     Thing.find().exists('name')\n     */\n    exists(_path: string, _val: number): NoSqlQueryBuilder<DocType> {\n        let path;\n        let val;\n        if (0 === arguments.length) {\n            this._ensurePath('exists');\n            path = this._path;\n            val = true;\n        } else if (1 === arguments.length) {\n            if ('boolean' === typeof arguments[0]) {\n                this._ensurePath('exists');\n                path = this._path;\n                val = arguments[0];\n            } else {\n                path = arguments[0];\n                val = true;\n            }\n        } else if (2 === arguments.length) {\n            path = arguments[0];\n            val = arguments[1];\n        }\n\n        const conds = (this._conditions as any)[path] || ((this._conditions as any)[path] = {});\n        conds.$exists = val;\n        return this as any;\n    }\n\n    /**\n     * Specifies an `$elemMatch` condition\n     * ####Example\n     *     query.elemMatch('comment', { author: 'autobot', votes: {$gte: 5}})\n     *     query.where('comment').elemMatch({ author: 'autobot', votes: {$gte: 5}})\n     *     query.elemMatch('comment', function (elem) {\n     *       elem.where('author').equals('autobot');\n     *       elem.where('votes').gte(5);\n     *     })\n     *     query.where('comment').elemMatch(function (elem) {\n     *       elem.where({ author: 'autobot' });\n     *       elem.where('votes').gte(5);\n     *     })\n     */\n    elemMatch(_path: string, _criteria: any): NoSqlQueryBuilder<DocType> {\n        if (null === arguments[0])\n            throw newRxTypeError('MQ2');\n\n        let fn;\n        let path;\n        let criteria;\n\n        if ('function' === typeof arguments[0]) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            fn = arguments[0];\n        } else if (isObject(arguments[0])) {\n            this._ensurePath('elemMatch');\n            path = this._path;\n            criteria = arguments[0];\n        } else if ('function' === typeof arguments[1]) {\n            path = arguments[0];\n            fn = arguments[1];\n        } else if (arguments[1] && isObject(arguments[1])) {\n            path = arguments[0];\n            criteria = arguments[1];\n        } else\n            throw newRxTypeError('MQ2');\n\n        if (fn) {\n            criteria = new NoSqlQueryBuilderClass;\n            fn(criteria);\n            criteria = criteria._conditions;\n        }\n\n        const conds = (this._conditions as any)[path] || ((this._conditions as any)[path] = {});\n        conds.$elemMatch = criteria;\n        return this as any;\n    }\n\n    /**\n     * Sets the sort order\n     * If an object is passed, values allowed are 'asc', 'desc', 'ascending', 'descending', 1, and -1.\n     * If a string is passed, it must be a space delimited list of path names.\n     * The sort order of each path is ascending unless the path name is prefixed with `-` which will be treated as descending.\n     * ####Example\n     *     query.sort({ field: 'asc', test: -1 });\n     *     query.sort('field -test');\n     *     query.sort([['field', 1], ['test', -1]]);\n     */\n    sort(arg: any): NoSqlQueryBuilder<DocType> {\n        if (!arg) return this as any;\n        let len;\n        const type = typeof arg;\n        // .sort([['field', 1], ['test', -1]])\n        if (Array.isArray(arg)) {\n            len = arg.length;\n            for (let i = 0; i < arg.length; ++i) {\n                _pushArr(this.options, arg[i][0], arg[i][1]);\n            }\n\n            return this as any;\n        }\n\n        // .sort('field -test')\n        if (1 === arguments.length && 'string' === type) {\n            arg = arg.split(/\\s+/);\n            len = arg.length;\n            for (let i = 0; i < len; ++i) {\n                let field = arg[i];\n                if (!field) continue;\n                const ascend = '-' === field[0] ? -1 : 1;\n                if (ascend === -1) field = field.substring(1);\n                push(this.options, field, ascend);\n            }\n\n            return this as any;\n        }\n\n        // .sort({ field: 1, test: -1 })\n        if (isObject(arg)) {\n            const keys = Object.keys(arg);\n            keys.forEach(field => push(this.options, field, arg[field]));\n            return this as any;\n        }\n\n        throw newRxTypeError('MQ3', {\n            args: arguments\n        });\n    }\n\n    /**\n     * Merges another MQuery or conditions object into this one.\n     *\n     * When a MQuery is passed, conditions, field selection and options are merged.\n     *\n     */\n    merge(source: any): NoSqlQueryBuilder<DocType> {\n        if (!source) {\n            return this as any;\n        }\n\n        if (!canMerge(source)) {\n            throw newRxTypeError('MQ4', {\n                source\n            });\n        }\n\n        if (source instanceof NoSqlQueryBuilderClass) {\n            // if source has a feature, apply it to ourselves\n\n            if (source._conditions)\n                merge(this._conditions, source._conditions);\n\n            if (source._fields) {\n                if (!this._fields) this._fields = {};\n                merge(this._fields, source._fields);\n            }\n\n            if (source.options) {\n                if (!this.options) this.options = {};\n                merge(this.options, source.options);\n            }\n\n            if (source._distinct)\n                this._distinct = source._distinct;\n\n            return this as any;\n        }\n\n        // plain object\n        merge(this._conditions, source);\n\n        return this as any;\n    }\n\n    /**\n     * Finds documents.\n     * ####Example\n     *     query.find()\n     *     query.find({ name: 'Burning Lights' })\n     */\n    find(criteria: any): NoSqlQueryBuilder<DocType> {\n        if (canMerge(criteria)) {\n            this.merge(criteria);\n        }\n\n        return this as any;\n    }\n\n    /**\n     * Make sure _path is set.\n     *\n     * @param {String} method\n     */\n    _ensurePath(method: any) {\n        if (!this._path) {\n            throw newRxError('MQ5', {\n                method\n            });\n        }\n    }\n\n    toJSON(): {\n        query: MangoQuery<DocType>;\n        path?: string;\n    } {\n        const query: MangoQuery<DocType> = {\n            selector: this._conditions,\n        };\n\n        if (this.options.skip) {\n            query.skip = this.options.skip;\n        }\n        if (this.options.limit) {\n            query.limit = this.options.limit;\n        }\n        if (this.options.sort) {\n            query.sort = mQuerySortToRxDBSort(this.options.sort);\n        }\n\n        return {\n            query,\n            path: this._path\n        };\n    }\n}\n\nexport function mQuerySortToRxDBSort<DocType>(\n    sort: { [k: string]: 1 | -1; }\n): MangoQuerySortPart<DocType>[] {\n    return Object.entries(sort).map(([k, v]) => {\n        const direction: MangoQuerySortDirection = v === 1 ? 'asc' : 'desc';\n        const part: MangoQuerySortPart<DocType> = { [k]: direction } as any;\n        return part;\n    });\n}\n\n/**\n * Because some prototype-methods are generated,\n * we have to define the type of NoSqlQueryBuilder here\n */\n\nexport interface NoSqlQueryBuilder<DocType = any> extends NoSqlQueryBuilderClass<DocType> {\n    maxScan: ReturnSelfNumberFunction<DocType>;\n    batchSize: ReturnSelfNumberFunction<DocType>;\n    limit: ReturnSelfNumberFunction<DocType>;\n    skip: ReturnSelfNumberFunction<DocType>;\n    comment: ReturnSelfFunction<DocType>;\n\n    gt: ReturnSelfFunction<DocType>;\n    gte: ReturnSelfFunction<DocType>;\n    lt: ReturnSelfFunction<DocType>;\n    lte: ReturnSelfFunction<DocType>;\n    ne: ReturnSelfFunction<DocType>;\n    in: ReturnSelfFunction<DocType>;\n    nin: ReturnSelfFunction<DocType>;\n    all: ReturnSelfFunction<DocType>;\n    regex: ReturnSelfFunction<DocType>;\n    size: ReturnSelfFunction<DocType>;\n\n}\n\ndeclare type ReturnSelfFunction<DocType> = (v: any) => NoSqlQueryBuilder<DocType>;\ndeclare type ReturnSelfNumberFunction<DocType> = (v: number | null) => NoSqlQueryBuilder<DocType>;\n\n/**\n * limit, skip, maxScan, batchSize, comment\n *\n * Sets these associated options.\n *\n *     query.comment('feed query');\n */\nexport const OTHER_MANGO_ATTRIBUTES = ['limit', 'skip', 'maxScan', 'batchSize', 'comment'];\nOTHER_MANGO_ATTRIBUTES.forEach(function (method) {\n    (NoSqlQueryBuilderClass.prototype as any)[method] = function (v: any) {\n        this.options[method] = v;\n        return this;\n    };\n});\n\n\n/**\n * gt, gte, lt, lte, ne, in, nin, all, regex, size, maxDistance\n *\n *     Thing.where('type').nin(array)\n */\nexport const OTHER_MANGO_OPERATORS = [\n    'gt', 'gte', 'lt', 'lte', 'ne',\n    'in', 'nin', 'all', 'regex', 'size'\n];\nOTHER_MANGO_OPERATORS.forEach(function ($conditional) {\n    (NoSqlQueryBuilderClass.prototype as any)[$conditional] = function () {\n        let path;\n        let val;\n        if (1 === arguments.length) {\n            this._ensurePath($conditional);\n            val = arguments[0];\n            path = this._path;\n        } else {\n            val = arguments[1];\n            path = arguments[0];\n        }\n\n        const conds = this._conditions[path] === null || typeof this._conditions[path] === 'object' ?\n            this._conditions[path] :\n            (this._conditions[path] = {});\n        conds['$' + $conditional] = val;\n        return this;\n    };\n});\n\n\nfunction push(opts: any, field: string, value: any) {\n    if (Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ6', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    if (value && value.$meta) {\n        const sort = opts.sort || (opts.sort = {});\n        sort[field] = {\n            $meta: value.$meta\n        };\n        return;\n    }\n\n    const val = String(value || 1).toLowerCase();\n    if (!/^(?:ascending|asc|descending|desc|1|-1)$/.test(val)) {\n        if (Array.isArray(value)) value = '[' + value + ']';\n        throw newRxTypeError('MQ7', {\n            field,\n            value\n        });\n    }\n    // store `sort` in a sane format\n    const s = opts.sort || (opts.sort = {});\n    const valueStr = value.toString()\n        .replace('asc', '1')\n        .replace('ascending', '1')\n        .replace('desc', '-1')\n        .replace('descending', '-1');\n    s[field] = parseInt(valueStr, 10);\n}\n\nfunction _pushArr(opts: any, field: string, value: any) {\n    opts.sort = opts.sort || [];\n    if (!Array.isArray(opts.sort)) {\n        throw newRxTypeError('MQ8', {\n            opts,\n            field,\n            value\n        });\n    }\n\n    /*    const valueStr = value.toString()\n            .replace('asc', '1')\n            .replace('ascending', '1')\n            .replace('desc', '-1')\n            .replace('descending', '-1');*/\n    opts.sort.push([field, value]);\n}\n\n\n/**\n * Determines if `conds` can be merged using `mquery().merge()`\n */\nexport function canMerge(conds: any): boolean {\n    return conds instanceof NoSqlQueryBuilderClass || isObject(conds);\n}\n\n\nexport function createQueryBuilder<DocType>(query?: MangoQuery<DocType>): NoSqlQueryBuilder<DocType> {\n    return new NoSqlQueryBuilderClass(query) as NoSqlQueryBuilder<DocType>;\n}\n"],"mappings":"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"}